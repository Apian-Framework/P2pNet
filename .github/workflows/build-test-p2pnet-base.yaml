
name: Build/Test P2pNet.Base

env:
  SUBPROJECT: P2pNet.Base

on:
  push:
    branches: [ master ]
    paths:
    - 'src/${{ SUBPROJECT }}/**'
    - 'tests/${{ SUBPROJECT }}.Tests/**'

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.301

    - name: Checkout Target
      uses: actions/checkout@v2
      with:
        path: main

    - name: Checkout Apian dependencies (UniLog)
      uses: actions/checkout@v2
      with:
        repository: Apian-Framework/UniLog
        path: UniLog

    - name: Restore dependencies
      run: dotnet restore
      working-directory: main

    - name: Build
      run: dotnet build ./src/$SUBPROJECT --configuration Release --no-restore
      working-directory: main

    - name: Test
      run: >
        dotnet test ./tests/$SUBPROJECT.Tests
        --no-restore --verbosity normal
        -p:CollectCoverage=true -p:CoverletOutput="./coverage/"
        -p:CoverletOutputFormat=cobertura -p:Include="[$SUBPROJECT]*"
      working-directory: main

    # - name: Where am I?
    #   run: |
    #     echo Pwd: "$(pwd)"
    #     echo ls: "$(ls)"
    #     echo Way down: "$(ls ./main/tests/P2pNet.Base.Tests/coverage/reports/)"

    # - name: Upload Coverage Badge
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: ${{env.SUBPROJECT}}_badge.svg
    #     path: ./main/tests/${{env.SUBPROJECT}}.Tests/coverage/reports/badge_linecoverage.svg

